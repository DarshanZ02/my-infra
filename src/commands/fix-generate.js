const fs = require("fs");
const path = require("path");
const { loadProwlerResults } = require("../services/prowlerService");
const { generateFixForCheck } = require("../services/fixService");
const { createPullRequest } = require("../services/githubService");


async function fixGenerateCommand(options) {
  const resourceId = options.resource;
  const issueId = options.issue;

  console.log("[Generate] -> Generating fix for:");
  console.log(`→ Resource: ${resourceId}`);
  console.log(`→ Issue: ${issueId}`);

  const results = loadProwlerResults();
  if (!results.length) {
    console.error("[Fail] -> No scan results found. Run: compliance-pilot scan aws");
    return;
  }

  // MATCH FINDING
  const match = results.find(r =>
    r.ResourceId.includes(resourceId) &&
    r.CheckTitle.toLowerCase().includes(issueId.toLowerCase())
  );

  if (!match) {
    console.error("[Fail] -> No matching finding found.");
    return;
  }

  console.log(`[Done] -> Found issue: ${match.CheckTitle}`);

  // Generate AI Fix
  const fixText = await generateFixForCheck(match);

  // Save Fix File
  const fixDir = path.join(process.cwd(), "fixes");
  if (!fs.existsSync(fixDir)) fs.mkdirSync(fixDir);

  const cleanFileName = `${resourceId}-${issueId}.md`.replace(/[^a-zA-Z0-9\-\.]/g, "_");
  const filePath = path.join(fixDir, cleanFileName);

  fs.writeFileSync(filePath, fixText, "utf8");

  console.log(`[Done] -> Fix saved: ${filePath}`);

  
  // ─────────────────────────────────────────────
  //  CREATE GITHUB PULL REQUEST AUTOMATICALLY
  // ─────────────────────────────────────────────
  

  const branchName = `fix/${issueId}-${resourceId}`.replace(/[^a-zA-Z0-9\/\-]/g, "_");
  const prTitle = `Fix: ${match.CheckTitle}`;
  const prBody = `
## Automated AWS Security Fix

This PR includes an auto-generated remediation guide for:

- **Resource:** ${resourceId}
- **Issue:** ${match.CheckTitle}
- **Severity:** ${match.Severity}

### What This Fix Contains
- AI-generated explanation
- AWS CLI steps (if applicable)
- Console instructions
- Risk prevented

---

Generated by **CompliancePilot CLI** 
`;

  console.log("\n[Create] -> Creating GitHub Pull Request...");
  await createPullRequest(branchName, filePath, prTitle, prBody);

  console.log("\n[Success] -> Fix + Pull Request created successfully!");
}

module.exports = { fixGenerateCommand };


