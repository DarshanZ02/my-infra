const fs = require("fs");
const path = require("path");
const { generateDocFromPolicy } = require("../services/docsService");
const { createPullRequest } = require("../services/githubService");

async function docsGenerateCommand(options) {
  const policyName = options.policy;

  if (!policyName) {
    console.error("‚ùå Missing policy name. Use: --policy \"Policy Name\"");
    return;
  }

  console.log("üìò Generating documentation for policy:");
  console.log(`‚Üí Policy: ${policyName}`);

  const policiesDir = path.join(process.cwd(), "policies");
  const policyFile = path.join(policiesDir, `${policyName}.json`);

  if (!fs.existsSync(policyFile)) {
    console.error(`‚ùå Policy file not found: ${policyFile}`);
    return;
  }

  // Load policy JSON
  const policyData = JSON.parse(fs.readFileSync(policyFile, "utf8"));

  // Generate documentation text using AI
  const docText = await generateDocFromPolicy(policyName, policyData);

  // Save documentation
  const docsDir = path.join(process.cwd(), "docs");
  if (!fs.existsSync(docsDir)) fs.mkdirSync(docsDir);

  const fileName = `${policyName.replace(/\s+/g, "-")}-documentation.md`;
  const filePath = path.join(docsDir, fileName);

  fs.writeFileSync(filePath, docText, "utf8");

  console.log(`üìÑ Documentation saved: ${filePath}`);

  //
  // CREATE PR FOR DOCUMENTATION
  //
  console.log("\nüì§ Creating GitHub Pull Request...");
  const branchName = `docs/${policyName.replace(/\s+/g, "-").toLowerCase()}`;
  const prTitle = `Documentation: ${policyName}`;
  const prBody = `
## Documentation Added

This PR adds autogenerated documentation for:

- **Policy:** ${policyName}

Generated via **CompliancePilot CLI**.
  `;

  await createPullRequest(branchName, filePath, prTitle, prBody);

  console.log("\nüéâ Documentation + PR created successfully!");
}

module.exports = { docsGenerateCommand };
